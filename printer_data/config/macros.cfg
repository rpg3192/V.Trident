#####################################################################
#   CONFIGURACIÓN DE SISTEMA (Beacon / Variables / Homing)
#####################################################################

[save_variables]
filename: ~/printer_data/config/variables.cfg



[axis_twist_compensation]
speed: 300
horizontal_move_z: 5
calibrate_start_x: 30
calibrate_end_x: 270
calibrate_y: 150
calibrate_start_y: 30
calibrate_end_y: 270
calibrate_x: 150

#####################################################################
#   MANTENIMIENTO (Limpieza / Carga / Descarga)
#####################################################################

[gcode_macro CLEAN_NOZZLE]
variable_start_x: 205
variable_end_x: 245
variable_y: 305        
variable_z: 10           # <--- ESTA ES LA ALTURA DE LIMPIEZA
variable_wipe_qty: 6
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

    SAVE_GCODE_STATE NAME=clean_state
    G90 # Posicionamiento absoluto

    # 1. Movimiento previo de seguridad: Primero ir a X e Y antes de bajar en Z
    G1 X{start_x} Y{y} F12000 
    
    # 2. Bajar a la altura del cepillo
    G1 Z{z} F3000 

    # 3. Movimiento de limpieza
    {% for wipes in range(1, (wipe_qty + 1)) %}
        G1 X{end_x} F12000
        G1 X{start_x} F12000
    {% endfor %}

    # 4. SUBIR AL TERMINAR para no arrastrar nada
    G1 Z15 F3000 

    RESTORE_GCODE_STATE NAME=clean_state

[gcode_macro LOAD_FILAMENT]
variable_purge_x: 255  
variable_purge_y: 312
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temp = 210 %}
    {% if material == "PETG" %} {% set temp = 240 %}
    {% elif material == "ABS" %} {% set temp = 255 %} {% endif %}

    {% if "xy" not in printer.toolhead.homed_axes %} G28 X Y {% endif %}

    SET_DISPLAY_TEXT MSG="Calentando para cargar {material}..."
    M109 S{temp}

    SAVE_GCODE_STATE NAME=load_state
    G90 
    {% if "z" in printer.toolhead.homed_axes %} G1 Z20 F3000 {% endif %}
    G1 X{purge_x} Y{purge_y} F12000
    
    G91 
    G1 E70 F300    # Carga rápida
    G1 E20 F150    # Purga
    G1 E-5 F5000   # Retracción rápida técnica
    
    # --- AQUÍ AGREGAMOS LA LIMPIEZA ---
    G90                             # Volver a posicionamiento absoluto
    SET_DISPLAY_TEXT MSG="Limpiando boquilla..."
    CLEAN_NOZZLE                    # <--- Asegúrate de que este sea el nombre de tu macro de limpieza
    # ---------------------------------

    RESTORE_GCODE_STATE NAME=load_state
    SET_DISPLAY_TEXT MSG="Carga completa"

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temp = 210 %}
    {% if material == "PETG" %} {% set temp = 240 %}
    {% elif material == "ABS" %} {% set temp = 255 %} {% endif %}

    SET_DISPLAY_TEXT MSG="Calentando para descargar {material}..."
    M109 S{temp}

    SAVE_GCODE_STATE NAME=unload_state
    G91
    # 1. Técnica anti-atasco (Ramming)
    G1 E5 F300          # Empujar para fundir punta vieja
    G1 E-15 F3000       # Retracción rápida inicial para romper el hilo
    G4 P2000            # Pausa para enfriar ligeramente la punta
    
    # 2. Retiro (Dividido en 40mm para evitar error de distancia máxima)
    G1 E-40 F1000       
    G1 E-40 F1000       
    G90
    RESTORE_GCODE_STATE NAME=unload_state
    SET_DISPLAY_TEXT MSG="Filamento retirado"

#####################################################################
#   MACROS DE IMPRESIÓN (Start / End)
#####################################################################

[gcode_macro PRINT_START]
variable_last_plate: "textured_pei"
variable_last_material: "pla"
gcode:
  # 1. Parámetros de Slicer y Variables
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set plate = params.PLATE|default("textured_pei")|lower|replace(" ", "_") %}
  {% set material = params.MATERIAL|default("pla")|lower %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  # Guardar info para Auto-Save de Offset en PRINT_END
  SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=last_plate VALUE='"{plate}"'
  SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=last_material VALUE='"{material}"'

  # 2. Inicialización Rápida
  SET_GCODE_OFFSET Z=0                                 
  CLEAR_PAUSE                                          
  BED_MESH_CLEAR                                       
  G90                                                  
  STATUS_HOMING
  G28                                                  # Home inicial (XYZ)
  M400

  # 3. Calentamiento Base
  SET_DISPLAY_TEXT MSG="Calentando Cama: {target_bed}c"
  STATUS_HEATING
  G1 X{x_wait} Y{y_wait} Z15 F9000                    # Ir al centro
  M190 S{target_bed}                                   # Esperar cama
  
  SET_DISPLAY_TEXT MSG="Hotend a 150c para limpieza"
  M109 S150                                            # Temp segura para Beacon

  # 4. Preparación Crítica del Nozzle y Z
  CLEAN_NOZZLE                                         # Limpiar restos de plástico
  M400                                                 

  SET_DISPLAY_TEXT MSG="Nivelando Z-Tilt"
  STATUS_LEVELING
  Z_TILT_ADJUST                                        # Nivelar motores Z
  M400
  G4 P500                                              # Pausa de estabilización

  SET_DISPLAY_TEXT MSG="Beacon Contact (Z-Final)"
  G28 Z METHOD=CONTACT CALIBRATE=1                     # Calibración real con nozzle limpio
  M400
  G4 P500

  # 5. Malla y Temperatura Final
  SET_DISPLAY_TEXT MSG="Generando Malla Adaptativa"
  STATUS_MESHING
  BED_MESH_CALIBRATE ADAPTIVE=1

  SET_DISPLAY_TEXT MSG="Calentando Hotend: {target_extruder}c"
  STATUS_HEATING
  G1 X5 Y5 Z10 F12000                                  # Espera en esquina para no gotear
  M107                                                 # Apagar ventilador de capa
  M109 S{target_extruder}                              # Temperatura final de impresión

  # 6. Inicio
  SET_DISPLAY_TEXT MSG="Limpieza final y Purga"
  LINE_PURGE                                           # Purga KAMP
  STATUS_PRINTING
  SET_DISPLAY_TEXT MSG="Imprimiendo..."

[gcode_macro PRINT_END]
gcode:
    # 1. Lógica de Auto-Save de Offset (Beacon)
    {% set current_offset = printer.gcode_move.homing_origin.z %}
    {% set plate = printer["gcode_macro PRINT_START"].last_plate %}
    {% set material = printer["gcode_macro PRINT_START"].last_material %}
    {% set var_name = "offset_" ~ plate ~ "_" ~ material %}

    {% if current_offset != 0 %}
        { action_respond_info("Z-OFFSET AUTO-SAVE: Guardando %.3f" % current_offset) }
        SAVE_VARIABLE VARIABLE='"{var_name}"' VALUE={current_offset}
    {% endif %}

    # 2. Finalización de hardware
    M400                           
    G92 E0                         
    G1 E-5.0 F3600                 # Retracción final
    TURN_OFF_HEATERS               
    
    G90                            
    # Levantar Z o ir al tope máximo
    G1 Z{[printer.toolhead.position.z + 50, printer.toolhead.axis_maximum.z]|min} F3000             
    G1 X290 Y10 F20000             # Presentar pieza
    
    M107                           
    BED_MESH_CLEAR                 
    SET_DISPLAY_TEXT MSG="Hecho."

[gcode_macro update_git]
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 90.0
verbose: True

[gcode_shell_command update_git_script_message]
command: bash -c "bash $HOME/klipper-backup/script.sh -c \"$0\""
timeout: 90.0
verbose: True