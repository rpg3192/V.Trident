#####################################################################
#   MACROS DE IMPRESIÓN (Start / End)
#####################################################################

#####################################################################
#   A better print_start macro for v2/trident
#####################################################################
#####################################################################
#   A better print_start macro for v2/trident - MODIFICADO
#####################################################################
[gcode_macro PRINT_START]
gcode:
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set plate = params.PLATE|default("textured_pei")|lower|replace(" ", "_") %}
  {% set material = params.MATERIAL|default("pla")|lower %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  # Variables for End Print
  SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=last_plate VALUE='"{plate}"'
  SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=last_material VALUE='"{material}"'

  # Load Offset Variables
  {% set var_name = "offset_" ~ plate ~ "_" ~ material %}
  {% set sv = printer.save_variables.variables %}
  {% set saved_offset = sv[var_name]|default(0.0)|float %}

  SET_GCODE_OFFSET Z=0
  CLEAR_PAUSE
  G90
  STATUS_HOMING
  G28
  BED_MESH_CLEAR

  # Step 1: Bed Heating & Heatsoak
  SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"
  STATUS_HEATING
  G1 X{x_wait} Y{y_wait} Z15 F9000
  M190 S{target_bed}

  # Step 2: Beacon Contact (Soak Temp)
  SET_DISPLAY_TEXT MSG="Hotend Soak: 150c"
  M109 S150                   # Wait for safe contact temp
  G28 Z METHOD=CONTACT CALIBRATE=1

  # Step 3: Leveling
  SET_DISPLAY_TEXT MSG="Z-Tilt Adjust"
  STATUS_LEVELING
  Z_TILT_ADJUST
  G28 Z                       # Re-home Z after leveling

  # Step 4: Adaptive Mesh
  SET_DISPLAY_TEXT MSG="Bed mesh"
  STATUS_MESHING
  BED_MESH_CALIBRATE ADAPTIVE=1

  # Step 5: Final Heating (DO THIS BEFORE CLEANING)
  G1 Z20 F9000                # Lift Z to avoid "Below model range" error
  SET_DISPLAY_TEXT MSG="Heating to {target_extruder}c"
  STATUS_HEATING
  M109 S{target_extruder}     # <--- PAUSE HERE until print temp reached

  # Step 6: Clean and Offset
  SET_DISPLAY_TEXT MSG="Limpiando..."
  CLEAN_NOZZLE                # Hotend is now at full temp, cleaning is effective
  
  G28 Z METHOD=CONTACT CALIBRATE=0 # Final Z check while clean/hot

  {% set total_offset = 0.06 + saved_offset %}
  SET_GCODE_OFFSET Z={total_offset} MOVE=1
  
  # Step 7: Purge Line
  SET_DISPLAY_TEXT MSG="Purgando..."
  STATUS_PRINTING
  G0 X{x_wait - 50} Y4 Z0.4 F10000 
  G91 
  G1 X100 E20 F1000           # This E20 will now work because M109 finished
  G90
  SET_DISPLAY_TEXT MSG="Imprimiendo..."
  
[gcode_macro PRINT_END]
gcode:
    # 1. Configuración de variables (debe coincidir con la base de PRINT_START)
    {% set base_offset = 0.06 %}
    {% set plate = printer["gcode_macro PRINT_START"].last_plate %}
    {% set material = printer["gcode_macro PRINT_START"].last_material %}
    {% set var_name = "offset_" ~ plate ~ "_" ~ material %}

    # 2. Captura del offset (Solución al error del diccionario)
    # Intentamos leer de gcode_move, si no, usamos el valor de homing_origin
    {% set final_total_offset = printer.gcode_move.homing_origin.z|float %}
    
    # 3. Cálculo: Offset Total - Base 0.06 = Tu ajuste manual
    {% set diff_to_save = final_total_offset - base_offset %}

    # Guardar en el archivo variables.cfg
    { action_respond_info("Z-OFFSET AUTO-SAVE: Guardando ajuste de %.3f para %s" % (diff_to_save, var_name)) }
    SAVE_VARIABLE VARIABLE='"{var_name}"' VALUE={diff_to_save}

    # --- Procedimiento de finalización estándar ---
    M400                           # Esperar a que terminen los movimientos
    G92 E0                         # Reset extrusor
    G1 E-5.0 F3600                 # Retraer filamento
    TURN_OFF_HEATERS
    G90                            # Posicionamiento absoluto
    
    # Levantar Z y retirar cabezal
    G1 Z{[printer.toolhead.position.z + 50, printer.toolhead.axis_maximum.z]|min} F3000
    G1 X290 Y10 F20000             # Mover a la esquina trasera
    
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0           # Limpiar offset para la próxima vez
    
    # Timelapse y mensajes
    # TIMELAPSE_RENDER             # Descomenta si usas Moonraker-Timelapse
    SET_DISPLAY_TEXT MSG="Impresión finalizada y guardada."

    #####################################################################
#   CONFIGURACIÓN DE SISTEMA (Beacon / Variables / Homing)
#####################################################################



[save_variables]
filename: ~/printer_data/config/variables.cfg



[axis_twist_compensation]
speed: 300
horizontal_move_z: 5
calibrate_start_x: 30
calibrate_end_x: 270
calibrate_y: 150
calibrate_start_y: 30
calibrate_end_y: 270
calibrate_x: 150

#####################################################################
#   MANTENIMIENTO (Limpieza / Carga / Descarga)
#####################################################################

[gcode_macro CLEAN_NOZZLE]
variable_start_x: 200
variable_end_x: 250
variable_y: 310
variable_z: 3
variable_wipe_qty: 6
gcode:
    SAVE_GCODE_STATE NAME=clean_state
    G90
    G1 Z15 F3000                 # Sube siempre antes de moverte al brush
    G1 X{start_x} Y{y} F12000    # Ve al brush
    G1 Z{z} F3000                # Baja al brush
    
    {% for wipes in range(wipe_qty) %}
        G1 X{end_x} F12000
        G1 X{start_x} F12000
    {% endfor %}

    G1 Z15 F3000                 # Sube ANTES de restaurar el estado
    RESTORE_GCODE_STATE NAME=clean_state MOVE=0 # El MOVE=0 evita movimientos fantasmas de Beacon

[gcode_macro LOAD_FILAMENT]
variable_purge_x: 260
variable_purge_y: 314
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temp = 210 %}
    {% if material == "PETG" %}
        {% set temp = 240 %}
    {% elif material == "ABS" %}
        {% set temp = 255 %}
    {% endif %}

    {% if "xy" not in printer.toolhead.homed_axes %}
        G28 X Y
    {% endif %}

    SET_DISPLAY_TEXT MSG="Calentando para cargar {material}..."
    M109 S{temp}

    SAVE_GCODE_STATE NAME=load_state
    G90

    # Baja cama antes de ir al bucket
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z30 F3000          # Deja buen espacio siempre
    {% endif %}

    # Ir al bucket de purga
    G1 X{purge_x} Y{purge_y} F12000

    G91
    G1 E70 F300
    G1 E20 F150
    G1 E-5 F5000

    G90

    SET_DISPLAY_TEXT MSG="Limpiando boquilla..."

    # BAJA CAMA OTRO 10 mm ANTES DE LIMPIAR
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z30 F3000          # Sube nozzle → cama baja
    {% endif %}

    CLEAN_NOZZLE

    RESTORE_GCODE_STATE NAME=load_state
    SET_DISPLAY_TEXT MSG="Carga completa"


[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temp = 210 %}
    {% if material == "PETG" %} {% set temp = 240 %}
    {% elif material == "ABS" %} {% set temp = 255 %} {% endif %}

    SET_DISPLAY_TEXT MSG="Calentando para descargar {material}..."
    M109 S{temp}

    SAVE_GCODE_STATE NAME=unload_state
    G91
    # 1. Técnica anti-atasco (Ramming)
    G1 E5 F300          # Empujar para fundir punta vieja
    G1 E-15 F3000       # Retracción rápida inicial para romper el hilo
    G4 P2000            # Pausa para enfriar ligeramente la punta
    
    # 2. Retiro (Dividido en 40mm para evitar error de distancia máxima)
    G1 E-40 F1000       
    G1 E-40 F1000       
    G90
    RESTORE_GCODE_STATE NAME=unload_state
    SET_DISPLAY_TEXT MSG="Filamento retirado"




[gcode_macro update_git]
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 90.0
verbose: True

[gcode_shell_command update_git_script_message]
command: bash -c "bash $HOME/klipper-backup/script.sh -c \"$0\""
timeout: 90.0
verbose: True