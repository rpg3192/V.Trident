#####################################################################
#   MACROS DE IMPRESIÓN (Start / End)
#####################################################################

[gcode_macro PRINT_START]
variable_last_plate: "textured_pei"
variable_last_material: "pla"
gcode:
  # --- 1. PARÁMETROS ---
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set plate = params.PLATE|default("textured_pei")|lower|replace(" ", "_") %}
  {% set material = params.MATERIAL|default("pla")|lower %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  # --- 2. LÓGICA DE OFFSET (SEGURIDAD 0.1 + GUARDADO) ---
  {% set safety_margin = 0.100 %} 
  {% set var_name = "offset_" ~ plate ~ "_" ~ material %}
  {% set sv = printer.save_variables.variables %}
  {% set saved_diff = sv[var_name]|default(0.0)|float %}
  {% set total_offset = safety_margin + saved_diff %}

  SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=last_plate VALUE='"{plate}"'
  SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=last_material VALUE='"{material}"'
  
  SET_GCODE_OFFSET Z=0          # Reset vital para seguridad
  CLEAR_PAUSE
  BED_MESH_CLEAR

  # --- 3. INICIO Y CALENTAMIENTO ---
  STATUS_HOMING
  G28
  G90
  SET_DISPLAY_TEXT MSG="Cama: {target_bed}c"
  STATUS_HEATING
  M190 S{target_bed}

  # --- 4. NIVELACIÓN TRIDENT ---
  SET_DISPLAY_TEXT MSG="Z-Tilt Adjust"
  STATUS_LEVELING
  Z_TILT_ADJUST
  G28 Z

  # --- 5. LIMPIEZA Y BEACON (USA CALIBRATE=0) ---
  SET_DISPLAY_TEXT MSG="Limpieza Nozzle (150c)"
  M109 S150
  CLEAN_NOZZLE                  # <--- Limpia restos antes de tocar
  
  SET_DISPLAY_TEXT MSG="Beacon: Buscando Zero"
  # USAMOS CALIBRATE=0 para no sobreescribir el modelo bueno cada vez
  G28 Z METHOD=CONTACT CALIBRATE=0 

  SET_DISPLAY_TEXT MSG="Bed Mesh Adaptativo"
  STATUS_MESHING
  BED_MESH_CALIBRATE ADAPTIVE=1

  # --- 6. CALENTAMIENTO FINAL ---
  SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"
  STATUS_HEATING
  G1 X{x_wait} Y{y_wait} Z15 F9000
  M109 S{target_extruder}

  # --- 7. APLICAR OFFSET Y TIMELAPSE ---
  { action_respond_info("Z-Offset: Seguridad(0.1) + Dif(%.3f) = TOTAL: %.3f" % (saved_diff, total_offset)) }
  SET_GCODE_OFFSET Z={total_offset} MOVE=1
  
  TIMELAPSE_TAKE_FRAME

  # --- 8. PURGA ---
  SET_DISPLAY_TEXT MSG="Imprimiendo..."
  STATUS_PRINTING
  G0 X{x_wait - 50} Y4 F10000
  G0 Z0.4
  G91
  G1 X100 E20 F1000
  G90
[gcode_macro PRINT_END]
gcode:
    {% set safety_margin = 0.100 %}
    {% set plate = printer["gcode_macro PRINT_START"].last_plate %}
    {% set material = printer["gcode_macro PRINT_START"].last_material %}
    {% set var_name = "offset_" ~ plate ~ "_" ~ material %}

    # Capturamos el offset real que tiene la máquina al terminar (incluyendo tu babystepping)
    {% set final_total_offset = printer.gcode_move.gcode_offset.z|float %}
    
    # Calculamos la diferencia: Lo que quedó al final menos el 0.1 inicial
    {% set diff_to_save = final_total_offset - safety_margin %}

    # Guardamos la diferencia para la próxima vez
    { action_respond_info("Z-OFFSET AUTO-SAVE: Total fue %.3f. Guardando diferencia: %.3f" % (final_total_offset, diff_to_save)) }
    SAVE_VARIABLE VARIABLE='"{var_name}"' VALUE={diff_to_save}

    # --- Resto del Print End normal ---
    M400
    G92 E0
    G1 E-5.0 F3600
    TURN_OFF_HEATERS
    G90
    G1 Z{[printer.toolhead.position.z + 50, printer.toolhead.axis_maximum.z]|min} F3000
    G1 X290 Y10 F20000
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0
    TIMELAPSE_RENDER
    SET_DISPLAY_TEXT MSG="Hecho y Guardado."

    #####################################################################
#   CONFIGURACIÓN DE SISTEMA (Beacon / Variables / Homing)
#####################################################################

[homing_override]
axes: x,y,z
gcode:
  G90

  {% set has_x = 'X' in params %}
  {% set has_y = 'Y' in params %}
  {% set has_z = 'Z' in params %}
  {% set no_params = (not has_x) and (not has_y) and (not has_z) %}

  {% set x_after_home = 40 %}    # X al que quieres ir después del home X

  # Posición del NOZZLE para que el Beacon quede en el centro de la cama
  {% set probe_cx = 150 %}
  {% set probe_cy = 150 %}
  {% set x_off = 0 %}
  {% set y_off = 22 %}
  {% set beacon_x = probe_cx - x_off %}
  {% set beacon_y = probe_cy - y_off %}

  # Detectar si viene METHOD (desde PRINT_START)
  {% set has_method = 'METHOD' in params %}

  # Estado de homing actual
  {% set homed = printer.toolhead.homed_axes %}
  {% set z_is_homed = 'z' in homed %}

  # Función simple de lift seguro: solo si Z está homed
  {% if z_is_homed %}
    {% set z_lift = printer.toolhead.position.z + 5 %}
  {% else %}
    {% set z_lift = None %}
  {% endif %}

  {% if no_params %}
    # -------------------------------
    #   G28        (Home All)
    #   X -> X+40 -> Y -> Beacon -> Z
    # -------------------------------

    {% if z_is_homed %}
      G1 Z{z_lift} F3000
    {% endif %}
    G28 X
    G1 X{x_after_home} F8000

    {% if z_is_homed %}
      G1 Z{z_lift} F3000
    {% endif %}
    G28 Y

    {% if z_is_homed %}
      G1 Z{z_lift} F3000
    {% endif %}
    G1 X{beacon_x} Y{beacon_y} F10000

    G28 Z

  {% else %}

    {% if has_x and has_y and (not has_z) %}
      # -------------------------------
      #   G28 X Y
      #   X -> X+40 -> Y
      # -------------------------------

      {% if z_is_homed %}
        G1 Z{z_lift} F3000
      {% endif %}
      G28 X
      G1 X{x_after_home} F8000

      {% if z_is_homed %}
        G1 Z{z_lift} F3000
      {% endif %}
      G28 Y

    {% else %}

      # -------------------------------
      #   G28 X
      # -------------------------------
      {% if has_x %}
        {% if z_is_homed %}
          G1 Z{z_lift} F3000
        {% endif %}
        G28 X
        G1 X{x_after_home} F8000
      {% endif %}

      # -------------------------------
      #   G28 Y
      # -------------------------------
      {% if has_y %}
        {% if z_is_homed %}
          G1 Z{z_lift} F3000
        {% endif %}
        G28 Y
      {% endif %}

      # -------------------------------
      #   G28 Z   /   G28 Z METHOD=CONTACT CALIBRATE=1
      # -------------------------------
      {% if has_z %}
        {% set homed2 = printer.toolhead.homed_axes %}

        {% if 'x' not in homed2 %}
          {% if z_is_homed %}
            G1 Z{z_lift} F3000
          {% endif %}
          G28 X
          G1 X{x_after_home} F8000
        {% endif %}

        {% if 'y' not in homed2 %}
          {% if z_is_homed %}
            G1 Z{z_lift} F3000
          {% endif %}
          G28 Y
        {% endif %}

        {% if z_is_homed %}
          G1 Z{z_lift} F3000
        {% endif %}
        G1 X{beacon_x} Y{beacon_y} F10000

        {% if has_method %}
          G28 Z METHOD=CONTACT CALIBRATE=1
        {% else %}
          G28 Z
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}



[save_variables]
filename: ~/printer_data/config/variables.cfg



[axis_twist_compensation]
speed: 300
horizontal_move_z: 5
calibrate_start_x: 30
calibrate_end_x: 270
calibrate_y: 150
calibrate_start_y: 30
calibrate_end_y: 270
calibrate_x: 150

#####################################################################
#   MANTENIMIENTO (Limpieza / Carga / Descarga)
#####################################################################

[gcode_macro CLEAN_NOZZLE]
variable_start_x: 200
variable_end_x: 250
variable_y: 310
variable_z: 10              # Altura del brush
variable_wipe_qty: 6
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

    SAVE_GCODE_STATE NAME=clean_state
    G90

    # --- Baja la cama 10 mm (sube el nozzle a Z20 en vez de bajar a Z10 directo) ---
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z{z + 10} F3000   # Ej: si z=10 → sube a Z20 (cama abajo)
    {% endif %}

    # Ir al brush
    G1 X{start_x} Y{y} F12000

    # Bajar a la altura real del brush
    G1 Z{z} F3000            # Vuelve a Z10 para limpiar

    # Movimiento de limpieza
    {% for wipes in range(wipe_qty) %}
        G1 X{end_x} F12000
        G1 X{start_x} F12000
    {% endfor %}

    # Subir/nozzle arriba para salir
    G1 Z{z + 10} F3000       # Sube a Z20 de nuevo (cama baja)

    RESTORE_GCODE_STATE NAME=clean_state

[gcode_macro LOAD_FILAMENT]
variable_purge_x: 260
variable_purge_y: 314
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temp = 210 %}
    {% if material == "PETG" %}
        {% set temp = 240 %}
    {% elif material == "ABS" %}
        {% set temp = 255 %}
    {% endif %}

    {% if "xy" not in printer.toolhead.homed_axes %}
        G28 X Y
    {% endif %}

    SET_DISPLAY_TEXT MSG="Calentando para cargar {material}..."
    M109 S{temp}

    SAVE_GCODE_STATE NAME=load_state
    G90

    # Baja cama antes de ir al bucket
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z30 F3000          # Deja buen espacio siempre
    {% endif %}

    # Ir al bucket de purga
    G1 X{purge_x} Y{purge_y} F12000

    G91
    G1 E70 F300
    G1 E20 F150
    G1 E-5 F5000

    G90

    SET_DISPLAY_TEXT MSG="Limpiando boquilla..."

    # BAJA CAMA OTRO 10 mm ANTES DE LIMPIAR
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z30 F3000          # Sube nozzle → cama baja
    {% endif %}

    CLEAN_NOZZLE

    RESTORE_GCODE_STATE NAME=load_state
    SET_DISPLAY_TEXT MSG="Carga completa"


[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temp = 210 %}
    {% if material == "PETG" %} {% set temp = 240 %}
    {% elif material == "ABS" %} {% set temp = 255 %} {% endif %}

    SET_DISPLAY_TEXT MSG="Calentando para descargar {material}..."
    M109 S{temp}

    SAVE_GCODE_STATE NAME=unload_state
    G91
    # 1. Técnica anti-atasco (Ramming)
    G1 E5 F300          # Empujar para fundir punta vieja
    G1 E-15 F3000       # Retracción rápida inicial para romper el hilo
    G4 P2000            # Pausa para enfriar ligeramente la punta
    
    # 2. Retiro (Dividido en 40mm para evitar error de distancia máxima)
    G1 E-40 F1000       
    G1 E-40 F1000       
    G90
    RESTORE_GCODE_STATE NAME=unload_state
    SET_DISPLAY_TEXT MSG="Filamento retirado"




[gcode_macro update_git]
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 90.0
verbose: True

[gcode_shell_command update_git_script_message]
command: bash -c "bash $HOME/klipper-backup/script.sh -c \"$0\""
timeout: 90.0
verbose: True