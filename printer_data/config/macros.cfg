#####################################################################
#   MACROS DE IMPRESIÓN (Start / End)
#####################################################################

#####################################################################
#   A better print_start macro for v2/trident
#####################################################################
#####################################################################
#   A better print_start macro for v2/trident - MODIFICADO
#####################################################################
[gcode_macro PRINT_START]
# Último plate/material usados (para PRINT_END)
variable_last_plate: "textured_pei_plate"
variable_last_material: "pla"
gcode:
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set chamber = params.CHAMBER|default(0)|int %}

  # Normalizar nombres que vienen de Orca
  {% set plate_raw = params.PLATE|default("Textured PEI Plate") %}
  {% set material_raw = params.MATERIAL|default("PLA") %}

  {% set plate = plate_raw|lower
                           |replace(" ", "_")
                           |replace("(", "")
                           |replace(")", "")
                           |replace("/", "_") %}
  {% set material = material_raw|lower
                                 |replace(" ", "_")
                                 |replace("/", "_") %}

  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  # Guardar plate/material para PRINT_END
  SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=last_plate VALUE="{plate}"
  SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=last_material VALUE="{material}"

  # Leer offset desde variables.cfg, o 0.4 si no existe
  {% set var_name = "offset_" ~ plate ~ "_" ~ material %}
  {% set sv = printer.save_variables.variables %}
  {% if var_name in sv %}
    {% set saved_offset = sv[var_name]|float %}
  {% else %}
    {% set saved_offset = 0.4 %}
  {% endif %}

  # Offset base fijo que tú usas
  {% set base_offset = 0.06 %}
  {% set total_offset = base_offset + saved_offset %}

  # Preparación
  SET_GCODE_OFFSET Z=0
  G90
  CLEAR_PAUSE
  STATUS_HOMING
  G28
  BED_MESH_CLEAR

  # Calentar cama
  SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"
  STATUS_HEATING
  G1 X{x_wait} Y{y_wait} Z15 F9000
  M190 S{target_bed}

  # Beacon a 150C (seguro para la cama)
  SET_DISPLAY_TEXT MSG="Hotend Soak: 150c"
  M109 S150
  G28 Z METHOD=CONTACT CALIBRATE=1

  # Z-tilt y re-home Z
  SET_DISPLAY_TEXT MSG="Z-Tilt Adjust"
  STATUS_LEVELING
  Z_TILT_ADJUST
  G28 Z

  # Mesh adaptativo
  SET_DISPLAY_TEXT MSG="Bed mesh"
  STATUS_MESHING
  BED_MESH_CALIBRATE ADAPTIVE=1

  # Calentamiento final del extrusor (siempre por encima de min_extrude_temp)
  {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|float %}
  {% set safe_extruder = target_extruder if target_extruder > (min_temp + 2.0) else (min_temp + 2.0) %}

  SET_DISPLAY_TEXT MSG="Hotend: {safe_extruder}c"
  STATUS_HEATING
  G1 Z20 F9000
  M109 S{safe_extruder}

  # Limpiar boquilla ya caliente
  SET_DISPLAY_TEXT MSG="Limpiando..."
  CLEAN_NOZZLE

  # Home Z con Beacon sin recalibrar
  G28 Z METHOD=CONTACT CALIBRATE=0

  # Aplicar offset total (base + variables.cfg)
  SET_GCODE_OFFSET Z={total_offset} MOVE=1

  TIMELAPSE_TAKE_FRAME

  # Línea de purga
  SET_DISPLAY_TEXT MSG="Purgando..."
  STATUS_PRINTING
  G0 X{x_wait - 50} Y4 Z0.4 F10000
  G91
  G1 X100 E20 F1000
  G90
  SET_DISPLAY_TEXT MSG="Imprimiendo..."


  
[gcode_macro PRINT_END]
gcode:
    # 1. Configuración de variables (debe coincidir con la base de PRINT_START)
    {% set base_offset = 0.06 %}
    {% set plate = printer["gcode_macro PRINT_START"].last_plate %}
    {% set material = printer["gcode_macro PRINT_START"].last_material %}
    {% set var_name = "offset_" ~ plate ~ "_" ~ material %}

    # 2. Captura del offset (Solución al error del diccionario)
    # Intentamos leer de gcode_move, si no, usamos el valor de homing_origin
    {% set final_total_offset = printer.gcode_move.homing_origin.z|float %}
    
    # 3. Cálculo: Offset Total - Base 0.06 = Tu ajuste manual
    {% set diff_to_save = final_total_offset - base_offset %}

    # Guardar en el archivo variables.cfg
    { action_respond_info("Z-OFFSET AUTO-SAVE: Guardando ajuste de %.3f para %s" % (diff_to_save, var_name)) }
    SAVE_VARIABLE VARIABLE='"{var_name}"' VALUE={diff_to_save}

    # --- Procedimiento de finalización estándar ---
    M400                           # Esperar a que terminen los movimientos
    G92 E0                         # Reset extrusor
    G1 E-5.0 F3600                 # Retraer filamento
    TURN_OFF_HEATERS
    G90                            # Posicionamiento absoluto
    
    # Levantar Z y retirar cabezal
    G1 Z{[printer.toolhead.position.z + 50, printer.toolhead.axis_maximum.z]|min} F3000
    G1 X290 Y10 F20000             # Mover a la esquina trasera
    
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0           # Limpiar offset para la próxima vez
    
    # Timelapse y mensajes
    # TIMELAPSE_RENDER             # Descomenta si usas Moonraker-Timelapse
    SET_DISPLAY_TEXT MSG="Impresión finalizada y guardada."

    #####################################################################
#   CONFIGURACIÓN DE SISTEMA (Beacon / Variables / Homing)
#####################################################################



[save_variables]
filename: ~/printer_data/config/variables.cfg



[axis_twist_compensation]
speed: 300
horizontal_move_z: 5
calibrate_start_x: 30
calibrate_end_x: 270
calibrate_y: 150
calibrate_start_y: 30
calibrate_end_y: 270
calibrate_x: 150

#####################################################################
#   MANTENIMIENTO (Limpieza / Carga / Descarga)
#####################################################################

[gcode_macro CLEAN_NOZZLE]
variable_start_x: 200
variable_end_x: 250
variable_y: 310
variable_z: 3
variable_wipe_qty: 6
gcode:
    SAVE_GCODE_STATE NAME=clean_state
    G90
    G1 Z15 F3000                 # Sube siempre antes de moverte al brush
    G1 X{start_x} Y{y} F12000    # Ve al brush
    G1 Z{z} F3000                # Baja al brush
    
    {% for wipes in range(wipe_qty) %}
        G1 X{end_x} F12000
        G1 X{start_x} F12000
    {% endfor %}

    G1 Z15 F3000                 # Sube ANTES de restaurar el estado
    RESTORE_GCODE_STATE NAME=clean_state MOVE=0 # El MOVE=0 evita movimientos fantasmas de Beacon

[gcode_macro LOAD_FILAMENT]
variable_purge_x: 260
variable_purge_y: 314
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temp = 210 %}
    {% if material == "PETG" %}
        {% set temp = 240 %}
    {% elif material == "ABS" %}
        {% set temp = 255 %}
    {% endif %}

    {% if "xy" not in printer.toolhead.homed_axes %}
        G28 X Y
    {% endif %}

    SET_DISPLAY_TEXT MSG="Calentando para cargar {material}..."
    M109 S{temp}

    SAVE_GCODE_STATE NAME=load_state
    G90

    # Baja cama antes de ir al bucket
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z30 F3000          # Deja buen espacio siempre
    {% endif %}

    # Ir al bucket de purga
    G1 X{purge_x} Y{purge_y} F12000

    G91
    G1 E70 F300
    G1 E20 F150
    G1 E-5 F5000

    G90

    SET_DISPLAY_TEXT MSG="Limpiando boquilla..."

    # BAJA CAMA OTRO 10 mm ANTES DE LIMPIAR
    {% if "z" in printer.toolhead.homed_axes %}
        G1 Z30 F3000          # Sube nozzle → cama baja
    {% endif %}

    CLEAN_NOZZLE

    RESTORE_GCODE_STATE NAME=load_state
    SET_DISPLAY_TEXT MSG="Carga completa"


[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set material = params.MATERIAL|default("PLA")|upper %}
    {% set temp = 210 %}
    {% if material == "PETG" %} {% set temp = 240 %}
    {% elif material == "ABS" %} {% set temp = 255 %} {% endif %}

    SET_DISPLAY_TEXT MSG="Calentando para descargar {material}..."
    M109 S{temp}

    SAVE_GCODE_STATE NAME=unload_state
    G91
    # 1. Técnica anti-atasco (Ramming)
    G1 E5 F300          # Empujar para fundir punta vieja
    G1 E-15 F3000       # Retracción rápida inicial para romper el hilo
    G4 P2000            # Pausa para enfriar ligeramente la punta
    
    # 2. Retiro (Dividido en 40mm para evitar error de distancia máxima)
    G1 E-40 F1000       
    G1 E-40 F1000       
    G90
    RESTORE_GCODE_STATE NAME=unload_state
    SET_DISPLAY_TEXT MSG="Filamento retirado"




[gcode_macro update_git]
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 90.0
verbose: True

[gcode_shell_command update_git_script_message]
command: bash -c "bash $HOME/klipper-backup/script.sh -c \"$0\""
timeout: 90.0
verbose: True